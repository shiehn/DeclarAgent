name: git-jira-workflow
description: Extract ticket from branch, update local Jira, append changelog, commit
inputs:
  commit_message:
    required: true
    description: The commit message
steps:
  - id: check_clean
    name: Ensure working tree is clean
    run: git diff --quiet && git diff --cached --quiet
  - id: get_branch
    run: git rev-parse --abbrev-ref HEAD
    outputs:
      branch: stdout
  - id: extract_ticket
    run: echo "${{steps.get_branch.outputs.branch}}" | grep -oE '[A-Z]+-[0-9]+'
    outputs:
      ticket_id: stdout
  - id: update_jira
    action: json.set
    with:
      file: fakejira.json
      path: "${{steps.extract_ticket.outputs.ticket_id}}.status"
      value: "In Review"
  - id: append_changelog
    action: file.append
    with:
      path: CHANGELOG.md
      content: "- [${{steps.extract_ticket.outputs.ticket_id}}] ${{inputs.commit_message}}\n"
  - id: commit
    run: git add -A && git commit -m "[${{steps.extract_ticket.outputs.ticket_id}}] ${{inputs.commit_message}}"
    destructive: true
